<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="has-navbar">

<div th:replace="~{fragments/_navbar :: navbar(${notificacoes}, ${usuarioNome})}"></div>

<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-calendar-event me-2"></i> Gerenciamento de Agendamentos
        </h2>
        <a th:href="@{/agendamentos/novo}" class="btn btn-success btn-lg shadow">
            <i class="bi bi-plus-circle-fill me-1"></i> Novo Agendamento
        </a>
    </div>

    <div th:if="${sucesso}" class="alert alert-success" role="alert" th:text="${sucesso}"></div>
    <div th:if="${erro}" class="alert alert-danger" role="alert" th:text="${erro}"></div>

    <div class="card shadow">
        <div class="card-body p-3">
            <table id="tabelaAgendamentos" class="table table-hover table-striped table-bordered align-middle w-100">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%;">ID</th>
                        <th style="width: 15%;">Cliente</th>
                        <th style="width: 15%;">Data/Hora</th>
                        <th style="width: 20%;">Serviço</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 20%;">Observações</th>
                        <th style="width: 15%;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div th:replace="~{fragments/_scripts :: scripts}"></div>
<script th:src="@{/lib/bootstrap/js/bootstrap.bundle.min.js}"></script>

<script>
    // Função para formatar o status com badges coloridos
    function renderStatus(status) {
        let badgeClass = '';
        switch (status) {
            case 'PENDENTE':
                badgeClass = 'bg-secondary';
                break;
            case 'CONFIRMADO':
                // Destaque para CONFIRMADO, pois permite iniciar a OS
                badgeClass = 'bg-primary'; 
                break;
            case 'CONCLUIDO':
                badgeClass = 'bg-success';
                break;
            case 'CANCELADO':
                badgeClass = 'bg-danger';
                break;
            default:
                badgeClass = 'bg-light text-dark';
        }
        return `<span class="badge ${badgeClass}">${status}</span>`;
    }

    // Função para renderizar as ações, incluindo o botão "Iniciar OS"
    function renderAcoes(idAgendamento, status) {
        let acoes = '';

        // 1. Botão INICIAR OS (Opção Principal)
        // Visível APENAS se o status for CONFIRMADO
        if (status === 'CONFIRMADO') {
            acoes += `
                <a href="/manutencao/nova/agendamento/${idAgendamento}" class="btn btn-sm btn-success me-1" title="Iniciar Ordem de Serviço">
                    <i class="bi bi-tools"></i> OS
                </a>`;
        }
        
        // 2. Botão EDITAR
        acoes += `
            <a href="/agendamentos/editar/${idAgendamento}" class="btn btn-sm btn-warning" title="Editar Agendamento">
                <i class="bi bi-pencil-fill"></i> Editar
            </a>`;
            
        // 3. Botão EXCLUIR
        acoes += `
            <a href="/agendamentos/excluir/${idAgendamento}" class="btn btn-sm btn-danger" title="Excluir Agendamento" 
                onclick="return confirm('Tem certeza que deseja excluir o agendamento #${idAgendamento}?');">
                <i class="bi bi-trash-fill"></i> Excluir
            </a>`;
        
        return `<div class="btn-group">${acoes}</div>`;
    }


    $(document).ready(function () {
        $('#tabelaAgendamentos').DataTable({
            responsive: true,
            ajax: {
                url: "/agendamentos/listar", // Seu endpoint JSON para listar todos os agendamentos
                dataSrc: "" 
            },
            deferRender: true,
            columns: [
                { data: "idAgendamento", className: 'text-center' },
                { data: "nomeCliente" },
                { data: "dataAgendamento" },
                { data: "descricaoServico" },
                { 
                    data: "statusAgendamento", 
                    render: renderStatus,
                    className: 'text-center' 
                },
                { data: "observacoes" },
                {
                    data: null, // Usa a linha completa
                    orderable: false,
                    className: 'text-center',
                    render: function(row) {
                        return renderAcoes(row.idAgendamento, row.statusAgendamento);
                    }
                }
            ],
            language: {
                sEmptyTable: "Nenhum agendamento encontrado",
                sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ agendamentos",
                sInfoEmpty: "Mostrando 0 até 0 de 0 agendamentos",
                sInfoFiltered: "(Filtrados de _MAX_ agendamentos)",
                sLengthMenu: "_MENU_ resultados por página",
                sLoadingRecords: "Carregando...",
                sProcessing: "Processando...",
                sZeroRecords: "Nenhum agendamento encontrado",
                sSearch: "Pesquisar:",
                oPaginate: {
                    sNext: "Próximo",
                    sPrevious: "Anterior",
                    sFirst: "Primeiro",
                    sLast: "Último"
                },
                oAria: {
                    sSortAscending: ": Ordenar colunas de forma ascendente",
                    sSortDescending: ": Ordenar colunas de forma descendente"
                }
            },
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50, 100]
        });
    });
</script>

</body>
</html>