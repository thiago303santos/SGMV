<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    </head>
<body class="has-navbar">

<div th:replace="~{fragments/_navbar :: navbar(${notificacoes}, ${usuarioNome})}"></div>

<div class="container mt-4">
    
    <h2 class="fw-bold mb-4 pb-2 border-bottom text-primary">
        <i class="bi bi-calendar-check me-2"></i> 
        <span th:text="${agendamento.idAgendamento == null ? 'Novo Agendamento' : 'Editar Agendamento # ' + agendamento.idAgendamento}"></span>
    </h2>

    <div class="card shadow mb-5">
        <div class="card-header bg-light">
            <h5 class="mb-0 text-dark"><i class="bi bi-pencil-square me-1"></i> Dados do Agendamento</h5>
        </div>
        
        <div class="card-body">
            <form th:action="@{/agendamentos/salvar}" th:object="${agendamento}" method="post" class="row g-3">

                <input type="hidden" th:field="*{idAgendamento}"/>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="bi bi-person-fill"></i> Nome do Cliente</label>
                        <input type="text" th:field="*{nomeCliente}" class="form-control" placeholder="Nome completo ou CPF/CNPJ" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="bi bi-calendar-event"></i> Data e Hora</label>
                        <input type="datetime-local" th:field="*{dataAgendamento}" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="bi bi-check-circle"></i> Status</label>
                        <select th:field="*{statusAgendamento}" class="form-select">
                            <option th:value="PENDENTE">Pendente</option>
                            <option th:value="CONFIRMADO">Confirmado</option>
                            <option th:value="CONCLUIDO">Concluído</option>
                            <option th:value="CANCELADO">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="bi bi-tools"></i> Serviço Solicitado</label>
                        <input type="text" th:field="*{descricaoServico}" class="form-control" placeholder="Ex: Troca de óleo, Revisão de freios" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="bi bi-card-text"></i> Observações</label>
                        <textarea th:field="*{observacoes}" class="form-control" rows="6" placeholder="Detalhes adicionais sobre o cliente ou veículo..."></textarea>
                    </div>
                </div>

                <div class="col-12 mt-4 text-end border-top pt-3">
                    
                    <th:block th:if="${agendamento.idAgendamento != null and agendamento.statusAgendamento == 'CONFIRMADO'}">
                        <a th:href="@{'/manutencao/nova/agendamento/' + ${agendamento.idAgendamento}}" 
                           class="btn btn-success btn-lg shadow me-2">
                            <i class="bi bi-tools me-1"></i> Iniciar OS
                        </a>
                    </th:block>

                    <button type="submit" class="btn btn-primary btn-lg shadow me-2">
                        <i class="bi bi-save-fill"></i> Salvar Agendamento
                    </button>
                    
                    <a th:href="@{/agendamentos}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <h4 class="mb-3 text-dark"><i class="bi bi-list-task me-1"></i> Próximos Agendamentos</h4>
            <div class="card shadow">
                <div class="card-body p-3">
                    <table id="tabelaAgendamentos" class="table table-striped table-hover w-100">
                        <thead>
                            <tr class="table-dark">
                                <th style="width: 5%;">ID</th>
                                <th style="width: 15%;">Cliente</th>
                                <th style="width: 20%;">Data/Hora</th>
                                <th style="width: 20%;">Serviço</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 15%;">Observações</th>
                                <th style="width: 15%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    

</div>

<div th:replace="~{fragments/_scripts :: scripts}"></div>
<script th:src="@{/lib/bootstrap/js/bootstrap.bundle.min.js}"></script>

<script>
    // Função para formatar o status com badges coloridos
    function renderStatus(status) {
        let badgeClass = '';
        switch (status) {
            case 'PENDENTE':
                badgeClass = 'bg-secondary';
                break;
            case 'CONFIRMADO':
                // Destaque para CONFIRMADO, pois permite iniciar a OS
                badgeClass = 'bg-primary'; 
                break;
            case 'CONCLUIDO':
                badgeClass = 'bg-success';
                break;
            case 'CANCELADO':
                badgeClass = 'bg-danger';
                break;
            default:
                badgeClass = 'bg-light text-dark';
        }
        return `<span class="badge ${badgeClass}">${status}</span>`;
    }

    // Função para renderizar as ações, incluindo o botão "Iniciar OS"
    function renderAcoes(idAgendamento, status) {
        let acoes = '';

        // 1. Botão INICIAR OS (Opção Principal)
        // Visível APENAS se o status for CONFIRMADO
        if (status === 'CONFIRMADO') {
             acoes += `
                <a href="/manutencao/nova/agendamento/${idAgendamento}" class="btn btn-sm btn-success me-1" title="Iniciar Ordem de Serviço">
                    <i class="bi bi-tools"></i> OS
                </a>`;
        }
        
        // 2. Botão EDITAR
        acoes += `
            <a href="/agendamentos/editar/${idAgendamento}" class="btn btn-sm btn-warning" title="Editar Agendamento">
                <i class="bi bi-pencil-fill"></i> Editar
            </a>`;
            
        // 3. Botão EXCLUIR
        acoes += `
            <a href="/agendamentos/excluir/${idAgendamento}" class="btn btn-sm btn-danger" title="Excluir Agendamento" 
               onclick="return confirm('Tem certeza que deseja excluir o agendamento #${idAgendamento}?');">
                <i class="bi bi-trash-fill"></i> Excluir
            </a>`;
        
        return `<div class="btn-group">${acoes}</div>`;
    }


    function inicializarDataTable() {
        $('#tabelaAgendamentos').DataTable({
            destroy: true, 
            responsive: true,
            ajax: {
                url: "/agendamentos/listar", // Seu endpoint JSON
                dataSrc: "" 
            },
            deferRender: true,
            columns: [
                { data: "idAgendamento", className: 'text-center' },
                { data: "nomeCliente" },
                { data: "dataAgendamento" },
                { data: "descricaoServico" },
                { 
                    data: "statusAgendamento", 
                    render: renderStatus,
                    className: 'text-center' 
                },
                { data: "observacoes" },
                {
                    data: null, // Usa a linha completa
                    orderable: false,
                    className: 'text-center',
                    render: function(row) {
                        return renderAcoes(row.idAgendamento, row.statusAgendamento);
                    }
                }
            ],
            language: {
                sEmptyTable: "Nenhum registro encontrado",
                sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                sInfoEmpty: "Mostrando 0 até 0 de 0 registros",
                sInfoFiltered: "(Filtrados de _MAX_ registros)",
                sLengthMenu: "_MENU_ resultados por página",
                sLoadingRecords: "Carregando...",
                sProcessing: "Processando...",
                sZeroRecords: "Nenhum registro encontrado",
                sSearch: "Pesquisar",
                oPaginate: {
                    sNext: "Próximo",
                    sPrevious: "Anterior",
                    sFirst: "Primeiro",
                    sLast: "Último"
                },
                oAria: {
                    sSortAscending: ": Ordenar colunas de forma ascendente",
                    sSortDescending: ": Ordenar colunas de forma descendente"
                }
            }
        });
    }

    $(document).ready(function () {
        // Inicializar a DataTable automaticamente ao carregar a página
        inicializarDataTable();
    });
</script>

</body>
</html>