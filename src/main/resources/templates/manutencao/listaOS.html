<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}"></head>
<body class="has-navbar">

<div th:replace="~{fragments/_navbar :: navbar(${notificacoes}, ${usuarioNome})}"></div>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-card-checklist me-2"></i> Lista de Ordens de Serviço
        </h2>
        <a th:href="@{/manutencao/nova}" class="btn btn-success btn-lg shadow">
            <i class="bi bi-plus-circle-fill me-1"></i> Nova OS
        </a>
    </div>

    <div class="card shadow">
        <div class="card-body p-3">
            <table id="tabelaOS" class="table table-hover table-striped table-bordered w-100">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%;">ID</th>
                        <th style="width: 25%;">Cliente</th>
                        <th style="width: 20%;">Veículo (Modelo/Placa)</th>
                        <th style="width: 10%;">Data Entrada</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 10%;">Valor Total</th>
                        <th style="width: 20%;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

</div>

<div th:replace="~{fragments/_scripts :: scripts}"></div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<script>
    // Função para formatar o status com cores
    function renderStatus(status) {
        let badgeClass = '';
        switch (status) {
            case 'ABERTA':
                badgeClass = 'bg-danger';
                break;
            case 'EM_ANDAMENTO':
                badgeClass = 'bg-warning text-dark';
                break;
            case 'CONCLUIDA':
                badgeClass = 'bg-success';
                break;
            default:
                badgeClass = 'bg-secondary';
        }
        return `<span class="badge ${badgeClass}">${status}</span>`;
    }

    // Função para formatar valores monetários
    function renderMoeda(valor) {
        if (valor == null) return 'R$ 0,00';
        return "R$ " + parseFloat(valor).toFixed(2).replace('.', ',');
    }

    $(document).ready(function () {
        $('#tabelaOS').DataTable({
            processing: true,
            serverSide: false, // Usaremos o modo client-side, buscando todos os dados de uma vez
            ajax: {
                url: '/manutencao/lista-json', // Endpoint JSON que você já tem
                dataSrc: '' // Indica que a resposta é uma lista (não um objeto com a chave 'data')
            },
            columns: [
                { data: 'id', className: 'text-center' },
                { data: 'nomeCliente' },
                { 
                    data: null, 
                    render: (data) => `${data.modelo} / ${data.placa || 'N/A'}` 
                },
                { data: 'dataEntrada' },
                { 
                    data: 'status', 
                    render: renderStatus, 
                    className: 'text-center' 
                },
                { 
                    data: 'vlTotal', 
                    render: renderMoeda,
                    className: 'text-end fw-bold'
                },
                { 
                    data: 'id',
                    orderable: false,
                    className: 'text-center',
                    render: function(id) {
                        return `
                            <div class="btn-group" role="group">
                                <a href="/manutencao/detalhes/${id}" class="btn btn-sm btn-secondary" title="Ver Detalhes">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                <a href="/manutencao/pecas/${id}" class="btn btn-sm btn-info text-white" title="Adicionar Peças/Serviços">
                                    <i class="bi bi-gear-fill"></i>
                                </a>
                                <a href="/manutencao/editar/${id}" class="btn btn-sm btn-warning" title="Editar OS">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                            </div>`;
                    }
                }
            ],
            language: {
                url: '/lib/datatables/i18n/pt-BR.json' // tradução para PT-BR
            }
        });
    });
</script>

</body>
</html>