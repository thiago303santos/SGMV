<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'OS #' + ${manutencaoDTO.id} + ' (Relatório)'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Estilos de Impressão */
        /* ... (MANTIDO) ... */
        .container-fluid {
            padding: 0;
            max-width: 800px;
            margin: 0 auto;
        }
        /* Cabeçalho */
        .header-bg {
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        /* ... (Estilos de Tabela e Total) ... */
        /* Regras para MODO TELA vs. IMPRESSÃO */
        .no-print {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body> 
    
    <div class="no-print btn-group shadow">
        
        <button id="btnGerarPdf" class="btn btn-success">
            <i class="bi bi-file-earmark-pdf-fill"></i> Gerar PDF
        </button>
        
        <button id="btnImprimirNativo" class="btn btn-info text-white">
            <i class="bi bi-printer-fill"></i> Imprimir Documento
        </button>
    </div>
    
    <div class="container-fluid" id="conteudo-pdf">
        
        <div class="row header-bg">
            <div class="col-8">
                <h3 class="fw-bold">Nome da Oficina</h3>
                <p class="mb-0 small">CNPJ: 00.000.000/0000-00</p>
                <p class="mb-0 small">Endereço: UDF | Telefone: (61) 99999-9999 | Email: teste@gmail.com</p>
            </div>
            <div class="col-4 text-end">
                <h1 class="fw-bold text-info" style="font-size: 24pt;">OS #<span th:text="${manutencaoDTO.id}"></span></h1>
                <p class="mb-0 small">Data Entrada: <span th:text="${manutencaoDTO.dataEntrada}"></span></p>
                <p class="mb-0 small">Data Entrega: <span th:text="${manutencaoDTO.dataEntrega}"></span></p>
                <p class="mb-0 small">Profissional: <span th:text="${manutencaoDTO.profissional}"></span></p>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-6">
                <h6 class="pb-1 border-bottom fw-bold">Dados do Cliente</h6>
                <p class="mb-0 small"><strong>Nome:</strong> <span th:text="${manutencaoDTO.nomeCliente}"></span></p>
                <p class="mb-0 small"><strong>CPF:</strong> <span th:text="${manutencaoDTO.cpfCliente}"></span></p>
                <p class="mb-0 small"><strong>Telefone:</strong> <span th:text="${manutencaoDTO.telefoneCliente}"></span></p>
                <p class="mb-0 small"><strong>Email:</strong> <span th:text="${manutencaoDTO.emailCliente}"></span></p>
                <p class="mb-0 small"><strong>Endereço:</strong> <span th:text="${manutencaoDTO.enderecoCliente}"></span>, <span th:text="${manutencaoDTO.bairroCliente}"></span></p>
            </div>

            <div class="col-6">
                <h6 class="pb-1 border-bottom fw-bold">Dados do Veículo</h6>
                <p class="mb-0 small"><strong>Marca/Modelo:</strong> <span th:text="${manutencaoDTO.marca}"></span> / <span th:text="${manutencaoDTO.modelo}"></span></p>
                <p class="mb-0 small"><strong>Placa:</strong> <span th:text="${manutencaoDTO.placa}"></span> | <strong>Cor:</strong> <span th:text="${manutencaoDTO.cor}"></span> | <strong>Ano:</strong> <span th:text="${manutencaoDTO.ano}"></span></p>
                <p class="mb-0 small"><strong>Quilometragem:</strong> <span th:text="${manutencaoDTO.quilometragem}"></span> | <strong>Chassi:</strong> <span th:text="${manutencaoDTO.chassi}"></span></p>
                <p class="mb-0 small"><strong>Status OS:</strong> <span th:text="${manutencaoDTO.status}" class="fw-bold"></span></p>
            </div>
        </div>

        <h6 class="pb-1 border-bottom fw-bold mt-3">2. Serviços (Mão de Obra)</h6>
        <table class="table table-sm table-bordered table-print mb-4 w-100">
            <thead>
                <tr class="table-light">
                    <th style="width: 50%;">Descrição</th>
                    <th class="text-center" style="width: 50px;">Qt</th>
                    <th class="text-end" style="width: 100px;">Val. Unit. (R$)</th>
                    <th class="text-end" style="width: 120px;">Val. Total (R$)</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="servico : ${manutencaoDTO.servicos}">
                    <td th:text="${servico.descricao}"></td>
                    <td class="text-center" th:text="${servico.quantidade}"></td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(servico.valorUnitario, 1, 2, 'POINT')}"></td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(servico.valorTotal, 1, 2, 'POINT')}"></td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="table-light fw-bold">
                    <td colspan="3" class="text-end">Total Serviços</td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(manutencaoDTO.totalServicos, 1, 2, 'POINT')}"></td>
                </tr>
            </tfoot>
        </table>

        <h6 class="pb-1 border-bottom fw-bold mt-3">3. Peças</h6>
        <table class="table table-sm table-bordered table-print mb-4 w-100">
            <thead>
                <tr class="table-light">
                    <th style="width: 50%;">Descrição</th>
                    <th class="text-center" style="width: 70px;">Un</th>
                    <th class="text-center" style="width: 50px;">Qt</th>
                    <th class="text-end" style="width: 100px;">Val. Unit. (R$)</th>
                    <th class="text-end" style="width: 120px;">Val. Total (R$)</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="peca : ${manutencaoDTO.pecas}">
                    <td th:text="${peca.nomeProduto}"></td>
                    <td class="text-center" th:text="${peca.unidade}"></td>
                    <td class="text-center" th:text="${peca.quantidade}"></td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(peca.valorUnitario, 1, 2, 'POINT')}"></td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(peca.valorTotal, 1, 2, 'POINT')}"></td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="table-light fw-bold">
                    <td colspan="4" class="text-end">Total Peças</td>
                    <td class="text-end" th:text="${#numbers.formatDecimal(manutencaoDTO.totalPecas, 1, 2, 'POINT')}"></td>
                </tr>
            </tfoot>
        </table>

        <div class="row mt-5">
            <div class="col-8">
                <p class="text-muted small">Descrição do Serviço (Problema Reportado): <span th:text="${manutencaoDTO.descricao}"></span></p>
                <p class="text-muted small">Observações/Recomendações: ___________________________________________________________</p>
            </div>
            <div class="col-4 text-end">
                <div class="total-box fw-bold text-success" style="font-size: 16pt;">
                    TOTAL GERAL: R$ <span th:text="${#numbers.formatDecimal(manutencaoDTO.vlTotal, 1, 2, 'POINT')}"></span>
                </div>
            </div>
        </div>

        <div class="row mt-5 pt-5">
            <div class="col-6 text-center">
                <p class="mb-0 border-top pt-2">Assinatura do Cliente</p>
            </div>
            <div class="col-6 text-center">
                <p class="mb-0 border-top pt-2">Assinatura do Profissional (<span th:text="${manutencaoDTO.profissional}"></span>)</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        document.getElementById('btnGerarPdf').addEventListener('click', function() {
            const element = document.getElementById('conteudo-pdf');
            const osId = [[${manutencaoDTO.id}]];
            
            const opt = {
                margin: 10,
                filename: `OS_${osId}_Relatorio.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        });
        
        // NOVO EVENTO: Aciona a impressão nativa
        document.getElementById('btnImprimirNativo').addEventListener('click', function() {
            window.print();
        });
    </script>
</body>
</html>