<!-- templates/manutencao/incluirPecas.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}"></head>
<body class="has-navbar">

<!-- Navbar -->
<div th:replace="~{fragments/_navbar :: navbar(${notificacoes}, ${usuarioNome})}"></div>

<div class="container mt-4">

    <!-- Título e botão voltar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Adicionar Peças - OS #<span th:text="${manutencaoDTO.id}"></span></h2>
        <a class="btn btn-secondary" th:href="@{/manutencao/lista}">Voltar</a>
    </div>

    <!-- Informações da OS -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Dados da Ordem de Serviço</h5>
            <div class="row">
                <div class="col-md-6">
                    <p>
                        <strong>Cliente:</strong> <span th:text="${manutencaoDTO.nomeCliente}">---</span><br/>
                        <strong>CPF:</strong> <span th:text="${manutencaoDTO.cpfCliente}">---</span><br/>
                        <strong>Telefone:</strong> <span th:text="${manutencaoDTO.telefoneCliente}">---</span><br/>
                        <strong>Email:</strong> <span th:text="${manutencaoDTO.emailCliente}">---</span>
                    </p>
                </div>
                <div class="col-md-6">
                    <p>
                        <strong>Veículo:</strong> <span th:text="${manutencaoDTO.modelo}">---</span> - <span th:text="${manutencaoDTO.placa}">---</span><br/>
                        <strong>Marca/Cor/Ano:</strong> <span th:text="${manutencaoDTO.marca}">---</span> / <span th:text="${manutencaoDTO.cor}">---</span> / <span th:text="${manutencaoDTO.ano}">---</span><br/>
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Data Entrada:</strong> <span th:text="${manutencaoDTO.dataEntrada}">---</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Quilometragem:</strong> <span th:text="${manutencaoDTO.quilometragem}">---</span></p>
                </div>
            </div>
            <p><strong>Status:</strong> <span th:text="${manutencaoDTO.status}">---</span></p>
            <p><strong>Descrição:</strong> <span th:text="${manutencaoDTO.descricao}">---</span></p>
        </div>
    </div>

    <!-- ROW PRINCIPAL: Produtos e Carrinho -->
    <div class="row">
        <!-- LEFT: Lista de Produtos -->
        <div class="col-md-7">
            <div class="mb-2">
                <input id="produtoBusca" class="form-control" placeholder="Digite para buscar (autocomplete)..." />
            </div>

            <table id="tabelaProdutos" class="table table-sm table-hover table-bordered w-100">
                <thead class="table-dark">
                    <tr>
                        <th>Código</th>
                        <th>Nome</th>
                        <th>Categoria</th>
                        <th>Unid.</th>
                        <th>Estoque</th>
                        <th>Preço</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- RIGHT: Carrinho da OS -->
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-body p-2">
                    <h5 class="card-title">Itens da OS</h5>
                    <table id="tabelaCarrinho" class="table table-sm table-striped table-bordered mb-2 w-100">
                        <thead class="table-secondary">
                            <tr>
                                <th>Cód</th>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Unid.</th>
                                <th>Estoque</th>
                                <th>Qtde</th>
                                <th>Remover</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="d-flex justify-content-between">
                        <button id="btnSalvarOS" class="btn btn-success btn-sm">Salvar OS</button>
                        <small class="text-muted">Ao adicionar, o estoque é reduzido automaticamente.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Produto -->
    <div class="modal fade" id="modalAdicionar" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="formAdicionar">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Adicionar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                  <input type="hidden" id="modalProdutoId">
                  <div class="mb-2"><strong id="modalProdutoNome"></strong></div>
                  <div class="row g-2">
                      <div class="col-6">
                          <label class="form-label">Quantidade</label>
                          <input id="modalQuantidade" type="number" min="1" class="form-control" value="1" required>
                      </div>
                      <div class="col-6">
                          <label class="form-label">Valor Unitário (R$)</label>
                          <input id="modalValorUnit" type="number" step="0.01" min="0" class="form-control" required>
                      </div>
                  </div>
                  <div class="mt-2">
                      <small id="modalEstoque" class="text-muted"></small>
                      <div id="modalErro" class="text-danger mt-1" style="display:none;"></div>
                  </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Adicionar</button>
              </div>
            </div>
        </form>
      </div>
    </div>

</div>

<!-- Scripts gerais -->
<div th:replace="~{fragments/_scripts :: scripts}"></div>
<script>
    const manutencaoId = [[${manutencaoDTO.id}]];
    let tabelaProdutos, tabelaCarrinho;

    $(document).ready(function () {

  tabelaProdutos = $('#tabelaProdutos').DataTable({
    ajax: { url: '/estoque/listar', dataSrc: '' },
    columns: [
        { data: 'idProduto' },
        { data: 'nomeProduto' },
        { data: 'categoria' },
        { 
            data: 'unidade',
            render: d => {
                if(!d) return '';
                d = d.toUpperCase();
                return d==='KG'?'kg':d==='LITRO'?'litro':d==='UNIDADE'?'unidade':d==='PECA'?'peça':d;
            }
        },
        { data: 'quantidade' },
        { 
            data: 'valorVenda',
            render: d => d != null ? "R$ "+parseFloat(d).toFixed(2) : "R$ 0,00"
        },
        {
            data: null,
            orderable: false,
            className: 'text-center',
            render: function(data, type, row) {
                // Aqui garantimos que row sempre existe
                if(!row) return '';
                
                return `<button class="btn btn-sm btn-primary btn-add"
                    data-id="${row.idProduto}"
                    data-nome="${row.nomeProduto}"
                    data-estoque="${row.quantidade}"
                    data-preco="${row.valorVenda != null ? parseFloat(row.valorVenda).toFixed(2) : 0}"
                    data-categoria="${row.categoria || ''}"
                    data-unidade="${row.unidade || ''}">
                    Adicionar
                </button>`;
            }
        }
    ],
    responsive: true,
    pageLength: 8
});

    // Carrinho
    tabelaCarrinho = $('#tabelaCarrinho').DataTable({
        paging:false, searching:false, info:false,
        ajax: { url: `/manutencao/${manutencaoId}/pecas/list`, dataSrc: '' },
        columns:[
            { data:'idProduto' },
            { data:'nomeProduto' },
            { data:'categoria', defaultContent:'' },
            { 
                data:'unidade', 
                render: d=> d==='KG'?'kg':d==='L'?'litro':d==='UN'?'unidade':d||''
            },
            { data:'quantidade' },
            { 
                data:'quantidade',
                render:(data,row)=>`<input type="number" min="1" class="form-control form-control-sm carrinho-qtde" data-id="${row.id}" value="${row.quantidade}">`
            },
            { data:null, orderable:false, render:(data,row)=>`<button class="btn btn-sm btn-danger btn-remove" data-id="${row.id}">Remover</button>` }
        ]
    });

    // Atualiza carrinho
    function carregarCarrinho(){ tabelaCarrinho.ajax.reload(); }
    carregarCarrinho();

    // Evento de abrir modal
$('#tabelaProdutos tbody').off('click', '.btn-add').on('click','.btn-add', function(){
    const btn = $(this);
    
    // Garantindo que todos os dados chegam do botão
    console.log('Produto clicado:', {
        id: btn.data('id'),
        nome: btn.data('nome'),
        estoque: btn.data('estoque'),
        preco: btn.data('preco'),
        categoria: btn.data('categoria'),
        unidade: btn.data('unidade')
    });
    
    $('#modalProdutoId').val(btn.data('id'));
    $('#modalProdutoNome').text(btn.data('nome'));
    $('#modalQuantidade').val(1);
    $('#modalValorUnit').val(parseFloat(btn.data('preco')).toFixed(2));
    $('#modalEstoque').text('Estoque: '+btn.data('estoque'));
    $('#modalErro').hide().text('');
    
    new bootstrap.Modal(document.getElementById('modalAdicionar')).show();
});

    $('#formAdicionar').on('submit', function(e){
        e.preventDefault();
        const produtoId = $('#modalProdutoId').val();
        const quantidade = parseInt($('#modalQuantidade').val());
        const valorUnit = parseFloat($('#modalValorUnit').val());

        $.ajax({
            url: `/manutencao/${manutencaoId}/pecas/add`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ produtoId, quantidade, valorUnit }),
            success: resp=>{
                if(resp.success){
                    carregarCarrinho();
                    tabelaProdutos.ajax.reload(null,false);
                    bootstrap.Modal.getInstance(document.getElementById('modalAdicionar')).hide();
                } else $('#modalErro').text(resp.message).show();
            },
            error:()=>$('#modalErro').text('Erro ao adicionar produto').show()
        });
    });

    $('#tabelaCarrinho tbody').on('click','.btn-remove', function(){
        const id = $(this).data('id');
        if(!confirm('Remover este item? Estoque será devolvido.')) return;
        $.post(`/manutencao/${manutencaoId}/pecas/remove`,{id})
            .done(resp=>{
                if(resp.success){ carregarCarrinho(); tabelaProdutos.ajax.reload(null,false); }
                else alert(resp.message||'Erro');
            });
    });

    let timer;
    $('#tabelaCarrinho tbody').on('change','.carrinho-qtde', function(){
        const input = $(this);
        const manPecaId = input.data('id');
        const novaQtde = parseInt(input.val());
        if(isNaN(novaQtde)||novaQtde<=0){ alert('Quantidade inválida'); carregarCarrinho(); return; }
        clearTimeout(timer);
        timer = setTimeout(()=>{
            $.ajax({
                url: `/manutencao/${manutencaoId}/pecas/update`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({id:manPecaId,quantidade:novaQtde}),
                success: resp=>{
                    if(resp.success){ carregarCarrinho(); tabelaProdutos.ajax.reload(null,false); }
                    else { alert(resp.message||'Não foi possível alterar'); carregarCarrinho(); }
                },
                error:()=>{ alert('Erro ao atualizar quantidade'); carregarCarrinho(); }
            });
        },400);
    });

});
</script>

</body>
</html>
