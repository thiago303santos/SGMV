<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}"></head>
<body class="has-navbar">

    <!-- Navbar -->
    <div th:replace="~{fragments/_navbar :: navbar(${notificacoes}, ${usuarioNome})}"></div>

    <div class="container mt-4">

        <!-- Cards de Funcionalidades -->
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card card-funcionalidade shadow text-center" 
                     th:onclick="|window.location.href='/agendamentos/novo'|">
                    <div class="card-body">
                        <span class="material-symbols-outlined fs-1">calendar_add_on</span>
                        <h5 class="card-title mt-2">Agendamento de Serviços</h5>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card card-funcionalidade shadow text-center" 
                     th:onclick="|window.location.href='/manutencao/nova'|">
                    <div class="card-body">
                        <span class="material-symbols-outlined fs-1">add_task</span>
                        <h5 class="card-title mt-2">Criar Ordem de Serviço</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-funcionalidade shadow text-center" 
                     th:onclick="|window.location.href='/ordem/lista'|">
                    <div class="card-body">
                        <span class="material-symbols-outlined fs-1">assignment</span>
                        <h5 class="card-title mt-2">Acompanhar Ordens</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-funcionalidade shadow text-center" 
                     th:onclick="|window.location.href='/estoque'|">
                    <div class="card-body">
                        <span class="material-symbols-outlined fs-1">inventory_2</span>
                        <h5 class="card-title mt-2">Gerenciar Estoque</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-funcionalidade shadow text-center" 
                     th:onclick="|window.location.href='/veiculos'|">
                    <div class="card-body">
                        <span class="material-symbols-outlined fs-1">directions_car</span>
                        <h5 class="card-title mt-2">Gerenciar Veículos</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-funcionalidade shadow text-center" 
                     th:onclick="|window.location.href='/clientes'|">
                    <div class="card-body">
                        <span class="material-symbols-outlined fs-1">group</span>
                        <h5 class="card-title mt-2">Gerenciar Clientes</h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- DataTable de Agendamentos -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">Agendamentos</div>
                    <div class="card-body">
                        <table id="tabelaAgendamentos" class="table table-striped table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Data/Hora</th>
                                    <th>Serviço</th>
                                    <th>Status</th>
                                    <th>Observações</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- DataTable de Agendamentos -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">Ordem de Serviço</div>
                    <div class="card-body">
                        <table id="tabelaAcompanharOrdem" class="table table-striped table-hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Veículo</th>
                                    <th>Data Entrada</th>
                                    <th>Descrição</th>
                                    <th>Status</th>
                                    <th>Valor Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mt-5">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header">Ordens de Serviço - Últimos 6 meses</div>
                    <div class="card-body">
                        <canvas id="graficoOrdens"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header">Estoque - Itens mais usados</div>
                    <div class="card-body">
                        <canvas id="graficoEstoque"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- Scripts -->
    <div th:replace="~{fragments/_scripts :: scripts}"></div>
    <script>
        $(document).ready(function () {
            inicializarDataTable();
            inicializarGraficos();
        });

        function inicializarDataTable() {
        $('#tabelaAgendamentos').DataTable({
            destroy: true, // permite re-inicializar a tabela
            responsive: true,
            ajax: {
                url: "/agendamentos/listar", // endpoint JSON
                dataSrc: "" // JSON já é uma lista
            },
            deferRender: true,
            columns: [
                { data: "idAgendamento" },
                { data: "nomeCliente" },
                { data: "dataAgendamento" },
                { data: "descricaoServico" },
                { data: "statusAgendamento" },
                { data: "observacoes" },
                {
                    data: "idAgendamento",
                    render: function(data, type, row) {
                        return `
                            <a href="/agendamentos/editar/${data}" class="btn btn-sm btn-edit">Editar</a>
                            <a href="/agendamentos/excluir/${data}" class="btn btn-sm btn-delete">Excluir</a>
                        `;
                    }
                }
            ],
            language: {
                sEmptyTable: "Nenhum registro encontrado",
                sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                sInfoEmpty: "Mostrando 0 até 0 de 0 registros",
                sInfoFiltered: "(Filtrados de _MAX_ registros)",
                sLengthMenu: "_MENU_ resultados por página",
                sLoadingRecords: "Carregando...",
                sProcessing: "Processando...",
                sZeroRecords: "Nenhum registro encontrado",
                sSearch: "Pesquisar",
                oPaginate: {
                    sNext: "Próximo",
                    sPrevious: "Anterior",
                    sFirst: "Primeiro",
                    sLast: "Último"
                },
                oAria: {
                    sSortAscending: ": Ordenar colunas de forma ascendente",
                    sSortDescending: ": Ordenar colunas de forma descendente"
                }
            }
        });
    }

        $(document).ready(function () {
    $('#tabelaAcompanharOrdem').DataTable({
        destroy: true,
        responsive: true,
        deferRender: true,
        ajax: {
            url: "/manutencao/lista-json", // endpoint JSON
            dataSrc: "" // o JSON já é uma lista
        },
        columns: [
            { data: "id" },
            { data: "nomeCliente" },
            { data: "modelo" },
            { 
                data: "dataEntrada",
                render: function(data) {
                    if (!data) return '';
                    const dt = new Date(data);
                    return dt.toLocaleDateString('pt-BR');
                }
            },
            { data: "descricao" },
            { 
                data: "status",
                render: function(data) {
                    let color = 'black';
                    if (data === 'EM_PROGRESSO' || data === 'Em andamento') color = 'orange';
                    else if (data === 'FINALIZADO' || data === 'Concluído') color = 'green';
                    else if (data === 'PENDENTE' || data === 'Pendente') color = 'red';
                    return `<span style="color:${color}; font-weight:bold;">${data}</span>`;
                }
            },
            { 
                data: "vlTotal",
                render: function(data) {
                    return data ? Number(data).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '';
                }
            },
            {
                data: "id",
                render: function(data, type, row) {
                    return `
                        <a href="/manutencao/editar/${data}" class="btn btn-warning btn-sm">Editar</a>
                        <a href="/manutencao/pecas/${data}" class="btn btn-info btn-sm">Peças</a>
                        <a href="/manutencao/detalhes/${data}" class="btn btn-secondary btn-sm">Detalhes</a>
                    `;
                }
            }
        ],
        language: {
            sEmptyTable: "Nenhum registro encontrado",
            sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
            sInfoEmpty: "Mostrando 0 até 0 de 0 registros",
            sInfoFiltered: "(Filtrados de _MAX_ registros)",
            sLengthMenu: "_MENU_ resultados por página",
            sLoadingRecords: "Carregando...",
            sProcessing: "Processando...",
            sZeroRecords: "Nenhum registro encontrado",
            sSearch: "Pesquisar",
            oPaginate: {
                sNext: "Próximo",
                sPrevious: "Anterior",
                sFirst: "Primeiro",
                sLast: "Último"
            },
            oAria: {
                sSortAscending: ": Ordenar colunas de forma ascendente",
                sSortDescending: ": Ordenar colunas de forma descendente"
            }
        }
    });
});




        function inicializarGraficos() {
        // Gráfico de Ordens
        new Chart(document.getElementById("graficoOrdens"), {
            type: 'line',
            data: {
            labels: ["Mai", "Jun", "Jul", "Ago", "Set", "Out"],
            datasets: [{
                label: "Ordens",
                data: [12, 19, 3, 5, 2, 10],
                borderColor: "#2f6fa3",
                backgroundColor: "rgba(47,111,163,0.2)",
                fill: true,
                tension: 0.35
            }]
            },
            options: {
            plugins: {
                legend: { labels: { color: "#122027" } }
            },
            scales: {
                x: { ticks: { color: "#5f6b75" } },
                y: { ticks: { color: "#5f6b75" } }
            }
            }
        });

            // Gráfico de Estoque
            new Chart(document.getElementById("graficoEstoque"), {
                type: 'doughnut',
                data: {
                labels: ["Óleo", "Pneu", "Filtro", "Pastilha"],
                datasets: [{
                    data: [30, 20, 25, 25],
                    backgroundColor: ["#2f6fa3", "#28a745", "#ffc107", "#dc3545"]
                }]
                },
                options: {
                plugins: {
                    legend: { labels: { color: "#122027" } }
                }
                }
            });
        }    
    </script>

</body>
</html>
