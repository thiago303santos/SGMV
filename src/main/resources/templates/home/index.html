<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head}"></head>
<body class="has-navbar">

<div th:replace="~{fragments/_navbartwo :: navbar(${notificacoes}, ${usuarioNome})}"></div>

<div class="container mt-4">
    
    <h1 class="fw-bold mb-4 pb-2 border-bottom text-primary">
        <i class="bi bi-speedometer2 me-2"></i>Central de Operações
    </h1>

    <div class="row g-4">
        
        <div class="col-md-4">
            <div class="card card-funcionalidade shadow text-center border-info" th:onclick="|window.location.href='/agendamentos/novo'|">
                <div class="card-body">
                    <i class="bi bi-calendar-plus display-6 text-info"></i>
                    <h5 class="card-title mt-2">Agendar Serviço</h5>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card card-funcionalidade shadow text-center border-success" th:onclick="|window.location.href='/manutencao/nova'|">
                <div class="card-body">
                    <i class="bi bi-plus-circle-fill display-6 text-success"></i>
                    <h5 class="card-title mt-2">Criar Ordem de Serviço</h5>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-funcionalidade shadow text-center border-primary" th:onclick="|window.location.href='/manutencao/lista/'|">
                <div class="card-body">
                    <i class="bi bi-card-list display-6 text-primary"></i>
                    <h5 class="card-title mt-2">Acompanhar Ordens</h5>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card card-funcionalidade shadow text-center border-warning" th:onclick="|window.location.href='/estoque/lista'|">
                <div class="card-body">
                    <i class="bi bi-boxes display-6 text-warning"></i>
                    <h5 class="card-title mt-2">Gerenciar Estoque</h5>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-funcionalidade shadow text-center border-secondary" th:onclick="|window.location.href='/veiculos'|">
                <div class="card-body">
                    <i class="bi bi-tools display-6 text-secondary"></i>
                    <h5 class="card-title mt-2">Gerenciar Veículos</h5>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-funcionalidade shadow text-center border-info" th:onclick="|window.location.href='/clientes'|">
                <div class="card-body">
                    <i class="bi bi-people display-6 text-info"></i>
                    <h5 class="card-title mt-2">Gerenciar Clientes</h5>
                </div>
            </div>
        </div>
    </div>


    <div class="row g-4 mt-4">
        
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-calendar-minus me-2"></i> Agendamentos Recentes/Pendentes
                </div>
                <div class="card-body p-3">
                    <table id="tabelaAgendamentos" class="table table-striped table-hover w-100 table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 30%;">Cliente</th>
                                <th style="width: 30%;">Data/Hora</th>
                                <th style="width: 25%;">Status</th>
                                <th style="width: 10%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-wrench-adjustable-circle me-2"></i> Ordens de Serviço em Andamento
                </div>
                <div class="card-body p-3">
                    <table id="tabelaAcompanharOrdem" class="table table-striped table-hover w-100 table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Veículo</th>
                                <th>Total</th>
                                <th style="width: 15%;">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5 g-4">
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-graph-up me-2"></i> Finanças - Últimos 6 meses
                </div>
                <div class="card-body">
                    <canvas id="graficoOrdens"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-pie-chart-fill me-2"></i> Estoque - Itens mais usados
                </div>
                <div class="card-body">
                    <canvas id="graficoEstoque"></canvas>
                </div>
            </div>
        </div>
    </div>
    
</div>
<div th:replace="~{fragments/_scripts :: scripts}"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">


<script>
    // -------------------------------------------------------------
    // FUNÇÕES DE RENDERIZAÇÃO AUXILIARES
    // -------------------------------------------------------------

    function renderStatusAgendamento(data) {
        let text = data || 'N/A';
        let badgeClass = '';
        switch (text) {
            case 'PENDENTE':
                badgeClass = 'bg-secondary';
                break;
            case 'CONFIRMADO':
                badgeClass = 'bg-success'; // Mudado para verde
                break;
            case 'CONCLUIDO':
                badgeClass = 'bg-primary';
                break;
            case 'CANCELADO':
                badgeClass = 'bg-danger';
                break;
            default:
                badgeClass = 'bg-light text-dark';
        }
        return `<span class="badge ${badgeClass}">${text}</span>`;
    }

    function renderStatusOS(data) {
        let text = data || 'N/A';
        let badgeClass = '';
        if (text.includes('ANDAMENTO')) {
            badgeClass = 'bg-warning text-dark';
        } else if (text.includes('ABERTA')) {
            badgeClass = 'bg-danger';
        } else if (text.includes('CONCLUIDA')) {
            badgeClass = 'bg-success';
        } else {
            badgeClass = 'bg-secondary';
        }
        return `<span class="badge ${badgeClass}">${text}</span>`;
    }

    function renderMoeda(data) {
        if (data == null || data === '') return 'R$ 0,00';
        // Garante que o valor seja tratado como número antes de formatar
        return Number(data).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function renderDataHora(data) {
        if (!data) return '';
        const dt = new Date(data);
        // Formato para Data e Hora completa (DD/MM/YYYY HH:MM)
        const datePart = dt.toLocaleDateString('pt-BR');
        const timePart = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        return `${datePart} ${timePart}`;
    }


    // -------------------------------------------------------------
    // DATATABLES INICIALIZAÇÃO
    // -------------------------------------------------------------
    
    $(document).ready(function () {
        inicializarDataTables();
        inicializarGraficos(); // Assume que Chart.js está carregado
    });

    function inicializarDataTables() {
        // --- 1. TABELA AGENDAMENTOS PENDENTES ---
        $('#tabelaAgendamentos').DataTable({
            destroy: true,
            responsive: true,
            ordering: false, 
            paging: false, info: false, searching: false,
            ajax: {
                url: "/agendamentos/listar", // Endpoint que lista todos os agendamentos
                dataSrc: "" 
            },
            columns: [
                { data: "idAgendamento", width: '5%', className: 'text-center' },
                { data: "nomeCliente" },
                { data: "dataAgendamento", render: renderDataHora },
                { data: "statusAgendamento", render: renderStatusAgendamento, className: 'text-center' },
                {
                    data: "idAgendamento",
                    width: '10%',
                    orderable: false,
                    className: 'text-center',
                    // Botão de acesso rápido para editar/detalhes
                    render: (data) => `<a href="/agendamentos/editar/${data}" class="btn btn-sm btn-info" title="Detalhes/Editar"><i class="bi bi-arrow-right"></i></a>`
                }
            ],
            language: { url: '/lib/datatables/i18n/pt-BR.json' } 
        });

        // --- 2. TABELA OS EM ANDAMENTO ---
        $('#tabelaAcompanharOrdem').DataTable({
            destroy: true,
            responsive: true,
            ordering: false,
            paging: false, info: false, searching: false,
            ajax: {
                url: "/manutencao/lista-json", 
                dataSrc: ""
            },
            columns: [
                { data: "id", width: '5%', className: 'text-center' },
                { data: "nomeCliente" },
                { data: "modelo" },
                { data: "vlTotal", render: renderMoeda, className: 'text-end' },
                {
                    data: "id",
                    width: '10%',
                    orderable: false,
                    className: 'text-center',
                    // Botão de acesso rápido para adicionar peças
                    render: (data) => `<a href="/manutencao/pecas/${data}" class="btn btn-sm btn-danger" title="Adicionar Peças/Serviços"><i class="bi bi-wrench"></i></a>`
                }
            ],
            language: { url: '/lib/datatables/i18n/pt-BR.json' }
        });
    }

    // -------------------------------------------------------------
    // GRÁFICOS INICIALIZAÇÃO
    // -------------------------------------------------------------

    function inicializarGraficos() {
        // --- Gráfico de Ordens (Linha) ---
        new Chart(document.getElementById("graficoOrdens"), {
            type: 'line',
            data: {
                labels: ["Mai", "Jun", "Jul", "Ago", "Set", "Out"],
                datasets: [{
                    label: "Valor Total (R$)",
                    data: [1200, 1900, 3000, 500, 2200, 1000],
                    borderColor: "#2f6fa3",
                    backgroundColor: "rgba(47,111,163,0.2)",
                    fill: true,
                    tension: 0.35
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "#122027" } } },
                scales: {
                    x: { ticks: { color: "#5f6b75" } },
                    y: { ticks: { color: "#5f6b75" } }
                }
            }
        });

        // --- Gráfico de Estoque (Rosca/Doughnut) ---
        new Chart(document.getElementById("graficoEstoque"), {
            type: 'doughnut',
            data: {
                labels: ["Óleo", "Pneu", "Filtro", "Pastilha"],
                datasets: [{
                    data: [30, 20, 25, 25],
                    backgroundColor: ["#2f6fa3", "#28a745", "#ffc107", "#dc3545"]
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "#122027" } } }
            }
        });
    }
</script>
</body>
</html>